name: Check Bazel Dependency Alignment

on:
  push:
    branches:
    - main
    paths:
    - "bazel/MODULE.bazel"
    - "bazel/versions.bzl"
    - ".github/workflows/check-bazel-alignment.yml"
  pull_request:
    paths:
    - "bazel/MODULE.bazel"
    - "bazel/versions.bzl"
    - ".github/workflows/check-bazel-alignment.yml"

permissions:
  contents: read

jobs:
  check-alignment:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Run dependency alignment check
      run: |
        cd bazel
        python3 verify_version_alignment.py
    
    - name: Summary
      if: always()
      run: |
        cd bazel
        echo "## Dependency Alignment Check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Verifying that MODULE.bazel and WORKSPACE dependencies are aligned..." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if python3 verify_version_alignment.py > /tmp/alignment_check.txt 2>&1; then
          echo "✅ **All dependencies are properly aligned!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Dependency alignment check failed!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please ensure MODULE.bazel versions match versions.bzl" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        cat /tmp/alignment_check.txt >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
