name: Publish to BCR

# This workflow publishes the envoy_toolshed module to the Bazel Central Registry (BCR).
# It is triggered when a GitHub Release is published with a tag matching 'bazel-v*'.
# The workflow creates a pull request against https://github.com/bazelbuild/bazel-central-registry
# using the templates defined in the .bcr directory.

on:
  # Triggered when a release is published
  release:
    types:
    - published
  # Allow manual trigger for republishing or testing
  workflow_dispatch:
    inputs:
      tag_name:
        required: true
        type: string
        description: "The git tag identifying the release to publish (e.g., bazel-v0.3.11)"

jobs:
  # Only run if this is a bazel-specific release tag
  check-tag:
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.check.outputs.should_publish }}
      tag_name: ${{ steps.check.outputs.tag_name }}
    steps:
    - name: Check if tag should be published
      id: check
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          TAG_NAME="${{ inputs.tag_name }}"
        else
          TAG_NAME="${{ github.event.release.tag_name }}"
        fi

        echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT

        if [[ "${TAG_NAME}" == bazel-v* ]]; then
          echo "should_publish=true" >> $GITHUB_OUTPUT
          echo "✓ Tag ${TAG_NAME} matches pattern 'bazel-v*' - will publish to BCR"
        else
          echo "should_publish=false" >> $GITHUB_OUTPUT
          echo "✗ Tag ${TAG_NAME} does not match pattern 'bazel-v*' - skipping BCR publish"
        fi

  publish:
    needs: check-tag
    if: needs.check-tag.outputs.should_publish == 'true'
    uses: bazel-contrib/publish-to-bcr/.github/workflows/publish.yaml@v6
    with:
      tag_name: ${{ needs.check-tag.outputs.tag_name }}
      # The BCR fork must be created manually - see README-BCR.md for setup instructions
      # This should be a fork of bazelbuild/bazel-central-registry in the envoyproxy organization
      registry_fork: envoyproxy/bazel-central-registry
      # Open the PR directly to the upstream BCR
      registry: bazelbuild/bazel-central-registry
      # Use tag prefix 'bazel-v' to extract version from tags like 'bazel-v0.3.11'
      tag_prefix: "bazel-v"
      # Open PRs as draft by default - maintainers can mark as ready for review
      draft: true
      # Enable attestations for enhanced security
      attest: true
    permissions:
      contents: write     # Needed to upload attestation files to the release
      id-token: write     # Needed to generate attestations
      attestations: write  # Needed to publish attestations
    secrets:
      # This PAT must be created and added as a repository secret
      # See README-BCR.md for instructions on creating the token
      publish_token: ${{ secrets.BCR_PUBLISH_TOKEN }}
